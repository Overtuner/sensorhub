#!/usr/bin/perl -wT

use strict;
use CGI;
use DBI;

my $formparam=" action='/cgi-bin/admin/sensorhub.pl' method='get'";
my $q     = new CGI;
my $dbh = DBI->connect("dbi:SQLite:/var/database/sensorhub.db", "", "", { RaiseError => 1 },) or die $DBI::errstr;
my @param=$q->param();
my $action=$q->param('action');
my @row;
my @row1;
my @job_headers=('Jobno','Seq','Node','Channel','Values','Test');

print $q->header( -type => "text/html", -expires => "-1d" );

        print $q->start_html(
            -title => 'Sensorhub Administration',
            -bgcolor => 'white',
            -style => { -code => ' /* Stylesheet code */
                    body { font-family: verdana, sans-serif; }
                    h1 { color: darkgreen; border-bottom: 1pt solid; width: 100%; }
                    h2 { color: darkblue; border-bottom: 1pt solid; width: 100%; }
#                    div { text-align: right; color: steelblue; border-top: darkblue 1pt solid; margin-top: 4pt; }
                    th { text-align: center; padding: 2pt; vertical-align: top; }
                    td { padding: 2pt; vertical-align: top; }
                    /* End Stylesheet code */ ',}, );
 
print "@param :: $action \n";

print $q->h1('Nodes');

my $sth = $dbh->prepare("SELECT * FROM node");
my @fields=('Node','Batterie Nennspannung', 'Batterie Grenzspannung', 'Standort');
print $q->start_table({-border=>1, cellpadding=>3});
print $q->Tr([$q->th([@fields])]);
$sth->execute(); 
while (@row = $sth->fetchrow_array()) {
  print "<tr><td><Form action=sensorhub.pl><input type=hidden name=action value=update_node>",
        "<input name=Node value='$row[0]'></td>",
        "<td><input name=UBATT value='$row[1]'></td>",
        "<td><input name=UBATTE value='$row[2]'></td>",
        "<td><input name=LOC value='$row[3]'></td>",
        "<td><input type=submit value=Edit></form>",
        "<Form $formparam><input type=hidden name=action value=del_node></input>",
        "<input type=submit value=Löschen></form></td></tr>"; 
#  print $q->start_form, $q->Tr([ $q->td([ @row, 
#        ($q->submit(-value => 'Editieren'),$q->end_form),
#        ($q->start_form,$q->submit(-value => 'Löschen'),$q->end_form) ]) ]);
}
  print "<Form><input type=hidden name=action value=new_node></input><tr>",
        "<td><input name=Node></input></td>",
        "<td><input name=UBATT></input></td>",
        "<td><input name=UBATTE></input></td>",
        "<td><input name=LOC></input></td>",
        "<td><input type=submit value='Neu anlegen'></form></td></tr>"; 
print $q->end_table;
$sth->finish();

print $q->h1('Sensoren');

my $sth = $dbh->prepare("SELECT jobno, jobdesc FROM jobdesc");
$sth->execute(); 
while (@row = $sth->fetchrow_array()) {
  my $sth1 = $dbh->prepare("SELECT jobno, seq, node, channel, value FROM job where Jobno = $row[0] ");
  $sth1->execute(); 
  print "<H2>Jobkette:<br> $row[1] </h2>";
  print $q->start_table({-border=>1, cellpadding=>3});
  print $q->Tr([$q->th([@job_headers])]);
  while (@row1 = $sth1->fetchrow_array()) {
    print $q->Tr([  $q->td([ @row1, 'test' ]) ]);
  }
  print $q->end_table;
  $sth1->finish();
}
$sth->finish();

 
        print $q->start_form(
            -name => 'main',
            -method => 'POST',
        );

        print $q->start_table;
        print $q->Tr(
          $q->td('Name:'),
          $q->td(
            $q->textfield(-name => "user_name", -size => 50)
          )
        );
        print $q->Tr(
          $q->td('Age:'),
          $q->td(
            $q->radio_group(
              -name => 'age',
              -values => [
                  '0-12', '13-18', '18-30', '30-40', '40-50', '50-60', '60-70', '70+'
              ],
              -rows => 4,
            )
          )
        );
        my %genders = ('F' => 'Female', 'M' => 'Male');
        print $q->Tr(
          $q->td('Gender:'),
          $q->td(
            $q->popup_menu(
              -name => 'gender',
              -values => [keys %genders],
              -labels => \%genders,
            )
          )
        );
        print $q->Tr(
          $q->td('Favourite Languages:'),
          $q->td(
            $q->checkbox_group(
              -name => 'language',
              -values => ['Perl', 'C', 'C++', 'C#', 'Java', 'VB', 'Python', 'Delphi'],
              -defaults => ['Perl'],
              -columns => 2,
            )
          )
        );
        print $q->Tr(
          $q->td($q->submit(-value => 'Submit')),
          $q->td('&nbsp;')
        );
        print $q->end_table;
        print $q->end_form;
    


